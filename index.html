<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Pencatat Pengeluaran</title>
<style>
  /* UI biasa */
  body { font-family: Inter, Arial, sans-serif; background:#f5f6f8; padding:20px; }
  .box { max-width:980px; margin:auto; background:#fff; padding:28px; border-radius:26px; border:1px solid #e5e7eb; box-shadow:0 8px 20px rgba(0,0,0,.1); }
  .title { text-align:center; font-size:28px; font-weight:800; margin-bottom:4px; color:#1c1c1c; }
  .title-line{ width:90px; height:6px; background:#facc15; border-radius:6px; margin:4px auto 20px; }
  input[type=text]{ width:100%; padding:12px; border-radius:14px; border:1px solid #d1d5db; background:#fafafa; }
  button{ padding:12px 20px; border-radius:14px; border:none; font-weight:600; cursor:pointer; }
  .btn-green{ background:#1b7c47; color:#fff } .btn-blue{ background:#3b82f6; color:#fff } .btn-red{ background:#ef4444; color:#fff } .btn-yellow{ background:#facc15; color:#1c1c1c }
  .card{ border-radius:18px; padding:20px; background:#fff; box-shadow:0 8px 16px rgba(0,0,0,.12); border:2px solid #1c1c1c }
  table{ width:100%; border-collapse:collapse; margin-top:10px; }
  th,td{ border:1px solid #1c1c1c; padding:8px; font-size:15px; }
  th{ background:#f1f5f9; text-align:center; }
  .flex{ display:flex; gap:10px; }
  .judul-box {
   flex: 1;
   max-width: 100%;
   }
  .nom-box{ max-width:190px }

  /* toast */
  .toast {
  position: fixed;
  top: 24px;              /* pindah ke atas */
  left: 50%;
  transform: translateX(-50%); padding:12px 22px; border-radius:12px; font-weight:600; color:#fff; opacity:0; transition:.3s; z-index:9999; }
  .toast.show{ opacity:1; transform:translateX(-50%) translateY(10px); }
  .toast.hidden{ display:none }
  .toast.success{ background:#16a34a } .toast.error{ background:#dc2626 } .toast.warn{ background:#eab308; color:#000 }

  /* modal */
.modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.4);
  backdrop-filter: blur(6px);            /* âœ¨ efek blur */
  -webkit-backdrop-filter: blur(6px);    /* Safari support */
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 99999;
  opacity: 0;
  transition: 0.25s ease;
}
  .modal.show{ opacity:1 }
  .modal.hidden{ display:none }
  .modal-content{ background:#fff; padding:24px; border-radius:18px; width:90%; max-width:360px; text-align:center; box-shadow:0 10px 30px rgba(0,0,0,.15); transform:scale(.85); transition:.25s }
  .modal.show .modal-content{ transform:scale(1) }
  .modal-content h3{ font-size:20px; font-weight:800; margin-bottom:8px }
  .modal-buttons{ display:flex; justify-content:center; gap:12px; margin-top:8px }
  .btn-cancel{ background:#e5e7eb; padding:10px 18px; border-radius:10px; font-weight:600 }
  .btn-danger{ background:#ef4444; color:#fff; padding:10px 18px; border-radius:10px; font-weight:600 }

  /* preview tabel style kecil */
  td:nth-child(1){ width:1cm; text-align:center }
  td:nth-child(2){ width:5.5cm }
  td:nth-child(3){ width:3cm; text-align:right }
.watermark {
  margin-top: 40px;
  text-align: center;
  font-size: 11px;
  color: #9ca3af; /* gray-400 */
  letter-spacing: 0.05em;
}

.watermark span {
  color: #14532d; /* green-900 */
  font-weight: 600;
}

.watermark .version {
  margin-top: 4px;
  font-size: 10px;
  color: #d1d5db; /* gray-300 */
}
.note-nominal {
  font-size: 12px;
  color: #6b9080;
  margin-bottom: 10px;
  line-height: 1.6;
  text-align: center;
  background: #E8EBEA;
  padding: 6px 10px;
  border-radius: 8px;
}
.modal-title {
  font-size: 18px;
  font-weight: 600;
  text-align: center;
  margin-bottom: 6px;
}

.modal-desc {
  text-align: center;
  font-size: 14px;
  color: #6b7280;
  margin-bottom: 12px;
}

.modal-input {
  width: 100%;
  padding: 10px;
  border-radius: 10px;
  border: 1px solid #d1d5db;
  font-size: 14px;
  text-align: center;
  margin-bottom: 14px;
}

.modal-actions {
  display: flex;
  gap: 10px;
}

.modal-actions button {
  flex: 1;
  padding: 10px;
  border-radius: 12px;
  font-weight: 600;
}
.modal-input {
  width: 100%;
  box-sizing: border-box;   /* âœ… ini yang bikin pas */
}
</style>
</head>
<body>

<div class="box">
  <h1 class="title">PENCATAT PENGELUARAN</h1>
  <div class="title-line"></div>

  <div class="flex" style="margin-bottom:14px;">
    <input id="judul" type="text" placeholder="Judul laporan..." class="judul-box">
    <button class="btn-green" onclick="setJudul()">Set</button>
  </div>
<div class="note-nominal">
  ðŸ’¡ Tanpa koma â†’ otomatis tambah <b>000</b><br>
  ðŸ’¡ Pakai koma ( , ) â†’ otomatis tambah <b>00</b> <br>
  Contoh: <b>3 â†’ 3.000</b> | <b>3,5 â†’ 3.500</b>
</div>
  <div class="flex" style="margin-bottom:14px;">
    <input id="ket" type="text" placeholder="Keterangan...">
    <input id="nom" type="text" placeholder="Nominal..." class="nom-box">
  </div>

  <button class="btn-green" style="width:100%; margin-bottom:18px;" onclick="addRow()">Tambah Pengeluaran</button>

  <div class="card">
    <h2 id="previewJudul" style="text-align:center; font-weight:800; font-size:20px;">[Belum Ada Judul]</h2>

    <table>
      <thead>
        <tr><th>NO</th><th>KETERANGAN</th><th>NOMINAL</th></tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>

    <div style="text-align:right; margin-top:10px; font-weight:bold;">
      Total: <span id="totalBox">0</span>
    </div>
    
  </div>

  <div class="flex" style="margin-top:20px; justify-content:center; flex-wrap:wrap;">
    <button class="btn-green" onclick="openDownloadModal()">Download File</button>
    <button class="btn-blue" onclick="copyText()">Copy</button>
    <button class="btn-red" onclick="openModal()">Reset</button>
  </div>
  <!-- WATERMARK -->
<div class="watermark">
  Â©Powered by <span>PP Daruttauhid Al Alawi</span>
  <div class="version">Version 5.11</div>
</div>
</div>

<div id="toast" class="toast hidden"></div>

<script>
const STORAGE_KEY = "data_laporan_offline";

// Simpan data ke localStorage
function saveData() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(rows));
}

// Ambil data saat halaman dibuka
function loadData() {
  let data = localStorage.getItem(STORAGE_KEY);
  if (data) {
    rows = JSON.parse(data);
  }

  // AMBIL JUDUL
  let savedJudul = localStorage.getItem("judul_laporan");
  if (savedJudul) {
    judul = savedJudul;
    document.getElementById("previewJudul").innerText = judul;
  }

  render();
}
/* ===== data ===== */
let rows = [];
let judul = "";

/* ===== helper ===== */
function fmt(n) {
  let str = String(n).trim();
  if (!str) return "0";

  // kalau pakai koma
  if (str.includes(",")) {
    let parts = str.split(",");
    let depan = parts[0].replace(/[^\d]/g, "");
    let belakang = (parts[1] || "").replace(/[^\d]/g, "").slice(0,1);

    if (!depan) return "0";

    let hasil = depan + (belakang || "0") + "00";
    return Number(hasil).toLocaleString("id-ID");
  }

  // kalau tanpa koma
  let angka = str.replace(/[^\d]/g, "");
  if (!angka) return "0";

  let hasil = angka + "000";
  return Number(hasil).toLocaleString("id-ID");
}
function escapeHtml(text) {
  if (text == null) return "";
  return String(text)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;");
}
function showToast(msg, type="success") {
  const toast = document.getElementById("toast");
  toast.className = "toast";
  toast.textContent = msg;
  toast.classList.add(type);
  toast.classList.remove("hidden");
  void toast.offsetWidth;
  toast.classList.add("show");
  setTimeout(()=>{ toast.classList.remove("show"); setTimeout(()=>toast.classList.add("hidden"),300); },2000);
}

/* ===== set judul ===== */
function setJudul() {
  const j = document.getElementById("judul").value.trim();
  if (!j) return showToast("Judul belum diisi!", "error");
  judul = j;
  document.getElementById("previewJudul").innerText = judul;

  // SIMPAN JUDUL
  localStorage.setItem("judul_laporan", judul);

  showToast("Judul berhasil disimpan!", "success");
}

/* ===== rows ===== */
function addRow() {
  const ket = document.getElementById("ket").value.trim();
  const nom = document.getElementById("nom").value.trim();
  if (!ket) return showToast("Keterangan belum diisi!", "error");
  if (!nom) return showToast("Nominal belum diisi!", "error");
  rows.push({ ket: ket, nom: fmt(nom) });
  document.getElementById("ket").value = "";
  document.getElementById("nom").value = "";
  saveData();
  function getNumber(nom) {
  return Number(nom.replace(/\./g, "")) || 0;
}
  render();
}
function render() {
  const tbody = document.getElementById("tbody");
  tbody.innerHTML = "";
  let total = 0;
  rows.forEach((r,i) => {
    total += Number(r.nom.replace(/\./g, ""));
    tbody.innerHTML += `<tr><td>${i+1}</td><td>${escapeHtml(r.ket)}</td><td>${escapeHtml(r.nom)}</td></tr>`;
  });
  document.getElementById("totalBox").innerText = total.toLocaleString("id-ID");
}

/* ===== copy ===== */
function copyText() {
  let text = (judul?judul+"\n\n":"");
  rows.forEach((r,i)=> text += `${i+1}. ${r.ket} - ${r.nom}\n`);
  text += `\nTotal: ${document.getElementById("totalBox").innerText}`;
  if (navigator.clipboard && window.isSecureContext) {
    navigator.clipboard.writeText(text).then(()=>showToast("Teks telah disalin!", "success")).catch(()=>fallbackCopy(text));
  } else fallbackCopy(text);
}
function fallbackCopy(text) {
  const ta = document.createElement("textarea"); ta.value = text; ta.style.position="fixed"; ta.style.opacity=0; document.body.appendChild(ta); ta.select(); document.execCommand("copy"); document.body.removeChild(ta); showToast("Teks telah disalin!", "success");
}

/* ===== reset modal ===== */
function openModal() { const m=document.getElementById("modalReset"); m.classList.remove("hidden"); void m.offsetWidth; m.classList.add("show"); }
function closeModal(){ const m=document.getElementById("modalReset"); m.classList.remove("show"); setTimeout(()=>m.classList.add("hidden"),250); }
function confirmReset(){
  let txt = document.getElementById("confirmResetText").value.trim().toLowerCase();

  if(txt !== "yes"){
    showToast("Ketik 'yes' untuk menghapus data", "warn");
    return;
  }

  // Reset tabel
  rows = [];
  render();

  // Reset judul
  document.getElementById("previewJudul").innerText = "[Belum Ada Judul]";

  // Hapus data tersimpan
  localStorage.removeItem("data_laporan_offline");

  // Kosongkan input modal
  document.getElementById("confirmResetText").value = "";

  // Tutup modal
  closeModal();

  // Notif
  showToast("Data berhasil direset!", "success");
}

/* ===== download modal ===== */
function openDownloadModal(){
  const modal = document.getElementById("modalDownload");
  document.getElementById("downloadName").value = judul || "laporan-pengeluaran";
  modal.classList.remove("hidden"); void modal.offsetWidth; modal.classList.add("show");
}
function closeDownloadModal(){ const m=document.getElementById("modalDownload"); m.classList.remove("show"); setTimeout(()=>m.classList.add("hidden"),250); }
function confirmDownload(){
  let name = document.getElementById("downloadName").value.trim(); if(!name) name="laporan-pengeluaran";
  let type = document.querySelector('input[name="fileType"]:checked').value;
  // prepare simple text content (for txt) and rely on downloadExcelXLS for excel
  if (type === "txt") {
    let t = (judul?judul+"\n\n":"");
    rows.forEach((r,i)=> t += `${i+1}. ${r.ket} - ${r.nom}\n`);
    t += `\nTotal: ${document.getElementById("totalBox").innerText}`;
    downloadTXT(t, name);
  } else {
    downloadExcelXLS(name);
  }
  closeDownloadModal();
}

/* ===== download TXT ===== */
function downloadTXT(content, filename){
  const blob = new Blob([content], { type: "text/plain" });
  const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = filename + ".txt"; a.click(); URL.revokeObjectURL(a.href);
}

/* ===== download Excel via HTML -> .xls (preserve CSS) ===== */
function downloadExcelXLS(filename){
  // konfigurasi ukuran (cm)
  const rowHeightCm = 0.7;
  const colNoCm = 1.1;
  const colKetCm = 5.5;
  const colNomCm = 3;

  let html = `
  <html>
  <head>
    <meta charset="utf-8" />
    <style>
      @page{ margin:0.5cm; }
      body{ font-family: "Times New Roman", serif; font-size:12pt; }
      table{ border-collapse:collapse; table-layout:fixed; }
      col.no{ width:42px; }
      col.ket{ width:208px; }
      col.nom{ width:114px; }
      th,td{ border:1px solid #000; padding:2px 4px;
        height:26px;
        line-height:26px;
      vertical-align:middle; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; }
      th{ font-weight:700; text-align:center; }
      .judul{ font-weight:700; text-align:center; vertical-align:middle; }
      .keterangan-left{ text-align:left; padding-left:6px; white-space:normal; line-height:1.1; }
      .center{ text-align:center; }
      .bold{ font-weight:700; }
    </style>
  </head>
  <body>
    <table>
      <colgroup>
        <col class="no" />
        <col class="ket" />
        <col class="nom" />
      </colgroup>

      <tr>
        <td class="judul bold center" colspan="3">${escapeHtml((judul || "LAPORAN PENGELUARAN").toUpperCase())}</td>
      </tr>
      <tr><td colspan="3" style="height:0.2cm"></td></tr>
      <tr>
        <th class="center">No</th>
        <th class="center">Keterangan</th>
        <th class="center">Nominal</th>
      </tr>
  `;

  // isi baris
  rows.forEach((r,i) => {
    html += `<tr>
      <td class="center">${i+1}</td>
      <td class="keterangan-left">${escapeHtml(r.ket)}</td>
      <td class="center">${escapeHtml(r.nom)}</td>
    </tr>`;
  });

  // total bold + center
  const totalText = document.getElementById("totalBox").innerText || "";
  html += `<tr>
    <td></td>
    <td class="center bold">Total</td>
    <td class="center bold">${escapeHtml(totalText)}</td>
  </tr>`;

  html += `</table></body></html>`;

  const blob = new Blob([html], { type: "application/vnd.ms-excel;charset=utf-8;" });
  const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = filename + ".xls"; a.click(); URL.revokeObjectURL(a.href);
}
window.onload = function() {
  loadData();
};
// ENTER pada input keterangan â†’ pindah ke nominal
document.getElementById("ket").addEventListener("keydown", function(e) {
  if (e.key === "Enter") {
    e.preventDefault();
    document.getElementById("nom").focus();
  }
});

// ENTER pada input nominal â†’ otomatis tambah data
document.getElementById("nom").addEventListener("keydown", function(e) {
  if (e.key === "Enter") {
    e.preventDefault();
    addRow(); // langsung tambah
    document.getElementById("ket").focus(); // balik ke input keterangan
  }
});
</script>

<!-- modal reset -->
<div id="modalReset" class="modal hidden">
  <div class="modal-content">

    <h3 class="modal-title">Konfirmasi Reset</h3>
    <p class="modal-desc">Ketik <b>yes</b> untuk menghapus semua data</p>

    <input 
      type="text" 
      id="confirmResetText" 
      placeholder="Ketik: yes"
      class="modal-input"
    >

    <div class="modal-actions">
      <button class="btn-cancel" onclick="closeModal()">Batal</button>
      <button class="btn-danger" onclick="confirmReset()">Reset</button>
    </div>

  </div>
</div>

<!-- modal download -->
<div id="modalDownload" class="modal hidden">
  <div class="modal-content">
    <h3>Download Laporan</h3>
    <p>Atur nama dan jenis file</p>

<input id="downloadName" type="text" placeholder="Nama file..."
  style="
    width:100%;
    max-width:300px;
    margin:0 auto 12px auto;
    display:block;
    padding:10px;
    border-radius:12px;
    border:1px solid #d1d5db;
    text-align:center;
  ">

    <div style="text-align:left;margin-bottom:14px;font-size:15px;">
      <label><input type="radio" name="fileType" value="txt" checked> TXT</label><br>
      <label><input type="radio" name="fileType" value="xls"> Excel</label>
    </div>

    <div class="modal-buttons">
      <button class="btn-cancel" onclick="closeDownloadModal()">Batal</button>
      <button class="btn-danger" onclick="confirmDownload()">Download</button>
    </div>
  </div>
</div>

</body>
</html>